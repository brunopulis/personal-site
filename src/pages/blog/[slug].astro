---
import { type CollectionEntry, getCollection, render } from "astro:content";

import { CalendarIcon, ClockIcon } from "@lucide/astro";

import Layout from "@layout/Layout.astro";
import Header from "@components/layouts/Header.astro";
import BuyMeCoffee from "@components/BuyMeCoffee.astro";
import ShareButton from "@/components/ShareButton.astro";
import EmailReplyButton from "@/components/EmailReplyButton.astro";
import BackBlog from "@components/blog/BackBlog.astro";
import Footer from "@components/layouts/Footer.astro";

// Gerar rotas para todos os posts
export async function getStaticPaths() {
	const posts = await getCollection("blog");

	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

type Props = {
	post: CollectionEntry<"blog">;
	prevPost: CollectionEntry<"blog">;
	nextPost: CollectionEntry<"blog">;
};

// Receber o post das props
const { post } = Astro.props;
const { Content } = await render(post);

// Formatar data para pt-BR
const publishDateString = String(post.data.publishDate);
const formattedDate = new Date(publishDateString).toLocaleDateString("pt-BR", {
	year: "numeric",
	month: "long",
	day: "numeric",
});

const isoDate = new Date(publishDateString).toISOString();

const postTitle = post.data.title;
const postUrl = Astro.url.href;

export const prerender = true;
---

<Layout
  title={`${post.data.title} + "Bruno Pulis"`}
  description="Artigos sobre desenvolvimento, acessibilidade e qualidade de software"
>
  <Header />
  <main id="main-content">
    <div class="min-h-screen bg-white">
      <BackBlog />

      <header class="bg-white px-6 py-12 lg:px-20">
        <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
          <div class="mb-4">
            <span
              class="focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive [a&]:hover:bg-primary/90 bg-blood-red-800 mb-4 inline-flex w-fit shrink-0 items-center justify-center gap-1 overflow-hidden rounded-md border border-transparent px-2 py-0.5 text-xs font-medium whitespace-nowrap text-white transition-[color,box-shadow] focus-visible:ring-[3px] [&>svg]:pointer-events-none [&>svg]:size-3"
            >
              {post.data.category}
            </span>
          </div>

          <h1 class="text-errie-black-900 mb-6 text-4xl leading-tight font-bold lg:text-5xl">
            {post.data.title}
          </h1>
          <p>{post.data.excerpt}</p>

          <div class="text-blood-red-800 mb-6 flex flex-wrap items-center gap-6 text-sm font-medium lg:text-base">
            <div class="flex items-center gap-2">
              <CalendarIcon class="h-4 w-4" aria-hidden="true" />
              <time datetime={isoDate}>{formattedDate}</time>
            </div>

            <div class="flex items-center gap-2">
              <ClockIcon class="h-4 w-4" aria-hidden="true" />
              <span>8 min de leitura</span>
            </div>
          </div>
        </div>
      </header>
      <article class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
        <div class="prose prose-lg max-w-none">
          <Content />

          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="mb-6">
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map((tag: string) => (
                  <a
                    href={`/blog/tags/${tag.toLowerCase()}`}
                    class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blood-red-800 focus:ring-offset-2"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <div class="mt-8 flex flex-wrap items-center gap-4">
            <ShareButton style="button" />
            <EmailReplyButton 
              postTitle={postTitle}
              postUrl={postUrl}
              style="button"
            />
          </div>

          <BuyMeCoffee variant="compact" />
        </div>
      </article>
    </div>
  </main>
  <Footer />
</Layout>

<script define:vars={{ postTitle, postUrl }}>
  document.addEventListener('DOMContentLoaded', () => {
    const shareButton = document.getElementById('share-button');
    
    if (shareButton) {
      shareButton.addEventListener('click', async () => {
        // Verifica se a API Web Share está disponível
        if (navigator.share) {
          try {
            await navigator.share({
              title: postTitle,
              url: postUrl,
            });
          } catch (err) {
            // Usuário cancelou ou erro ocorreu
            if (err.name !== 'AbortError') {
              console.error('Erro ao compartilhar:', err);
              fallbackCopyToClipboard();
            }
          }
        } else {
          // Fallback: copiar para área de transferência
          fallbackCopyToClipboard();
        }
      });
    }
    
    function fallbackCopyToClipboard() {
      navigator.clipboard.writeText(postUrl).then(() => {
        // Feedback visual
        const button = document.getElementById('share-button');
        const originalText = button.innerHTML;
        button.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Link copiado!';
        
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Não foi possível copiar o link. Por favor, copie manualmente: ' + postUrl);
      });
    }
  });
</script>