---
// src/pages/fluxo.astro
import Layout from '@layout/Layout.astro';
import { getCollection } from 'astro:content';

// Buscar todos os itens do stream
const streamItems = await getCollection('stream');

// Enriquecer com dados das collections detalhadas
const enrichedStream = await Promise.all(
  streamItems.map(async (item) => {
    let linkedContent = null;
    
    if (item.data.bookSlug) {
      const livros = await getCollection('biblioteca');
      linkedContent = livros.find(l => l.slug === item.data.bookSlug);
    } else if (item.data.filmSlug) {
      const filmes = await getCollection('movies');
      linkedContent = filmes.find(f => f.slug === item.data.filmSlug);
    } else if (item.data.musicSlug) {
      const musicas = await getCollection('musics');
      linkedContent = musicas.find(m => m.slug === item.data.musicSlug);
    }
    
    return { ...item, linkedContent };
  })
);

// Ordenar por data (mais recente primeiro)
const sortedStream = enrichedStream.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Agrupar por ano/m√™s para facilitar navega√ß√£o
const groupedByMonth = sortedStream.reduce((acc, item) => {
  const date = new Date(item.data.date);
  const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
  const label = date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
  
  if (!acc[key]) {
    acc[key] = { label, items: [] };
  }
  acc[key].items.push(item);
  return acc;
}, {});

// Mapear √≠cones e labels por tipo
const typeConfig = {
  book: { icon: 'üìö', label: 'Livro', color: 'bg-blue-50 border-blue-200' },
  film: { icon: 'üé¨', label: 'Filme', color: 'bg-purple-50 border-purple-200' },
  music: { icon: 'üéµ', label: 'M√∫sica', color: 'bg-pink-50 border-pink-200' },
  podcast: { icon: 'üéß', label: 'Podcast', color: 'bg-green-50 border-green-200' },
  concert: { icon: 'üé§', label: 'Show', color: 'bg-orange-50 border-orange-200' },
  link: { icon: 'üîó', label: 'Link', color: 'bg-gray-50 border-gray-200' },
  note: { icon: 'üí≠', label: 'Nota', color: 'bg-yellow-50 border-yellow-200' },
};

// Fun√ß√£o para formatar data
function formatDate(date: Date): string {
  return date.toLocaleDateString('pt-BR', { 
    day: 'numeric', 
    month: 'short', 
    year: 'numeric' 
  });
}

// Obter todas as tags √∫nicas para filtro
const allTags = [...new Set(
  sortedStream.flatMap(item => item.data.tags || [])
)].sort();
---

<Layout title="Fluxo - Bruno Pulis">
  <!-- Header/Nav -->
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="/" class="text-xl font-semibold text-gray-900">Bruno Pulis</a>
        <div class="flex gap-6 text-sm">
          <a href="/sobre" class="text-gray-600 hover:text-gray-900">sobre</a>
          <a href="/agora" class="text-gray-600 hover:text-gray-900">agora</a>
          <a href="/escrevendo" class="text-gray-600 hover:text-gray-900">escrevendo</a>
          <a href="/fluxo" class="text-gray-900 font-semibold">fluxo</a>
          <a href="/trabalho" class="text-gray-600 hover:text-gray-900">trabalho</a>
          <a href="/contato" class="text-gray-600 hover:text-gray-900">contato</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-6 py-16">
    
    <!-- Header da p√°gina -->
    <header class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Fluxo</h1>
      <p class="text-lg text-gray-600 max-w-2xl">
        Um registro do que tenho consumido, compartilhado e pensado. Livros, m√∫sicas, 
        filmes, links interessantes e reflex√µes soltas.
      </p>
    </header>

    <!-- Filtros/Stats -->
    <div class="mb-8 flex flex-wrap gap-4 items-center">
      <div class="flex gap-2 text-sm">
        <span class="text-gray-500">Filtrar por:</span>
        <button class="px-3 py-1 bg-gray-900 text-white rounded-full text-sm">
          Todos ({sortedStream.length})
        </button>
        {Object.entries(typeConfig).map(([type, config]) => {
          const count = sortedStream.filter(item => item.data.type === type).length;
          return count > 0 ? (
            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
              {config.icon} {config.label} ({count})
            </button>
          ) : null;
        })}
      </div>
    </div>

    <!-- Links para p√°ginas especializadas -->
    <div class="mb-12 flex gap-4 text-sm">
      <a href="/livros" class="text-blue-600 hover:text-blue-700">
        Ver todos os livros ‚Üí
      </a>
      <a href="/filmes" class="text-blue-600 hover:text-blue-700">
        Ver todos os filmes ‚Üí
      </a>
      <a href="/musicas" class="text-blue-600 hover:text-blue-700">
        Ver todas as m√∫sicas ‚Üí
      </a>
    </div>

    <!-- Stream agrupado por m√™s -->
    {Object.entries(groupedByMonth).map(([key, group]) => (
      <section class="mb-12" id={key}>
        <h2 class="text-2xl font-semibold text-gray-900 mb-6 sticky top-0 bg-gray-50 py-2 z-10">
          {group.label}
        </h2>
        
        <div class="space-y-4">
          {group.items.map(async (item) => {
            const config = typeConfig[item.data.type];
            const { Content } = await item.render();
            
            return (
              <article class={`border rounded-lg p-6 hover:border-gray-300 transition-colors ${config.color}`}>
                <div class="flex gap-4">
                  <!-- √çcone do tipo -->
                  <div class="flex-shrink-0 text-3xl">
                    {config.icon}
                  </div>
                  
                  <div class="flex-1">
                    <!-- Header do item -->
                    <div class="flex items-start justify-between mb-2">
                      <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-1">
                          {item.data.title}
                        </h3>
                        <div class="flex items-center gap-3 text-sm text-gray-500">
                          <span class="font-medium">{config.label}</span>
                          <span>‚Ä¢</span>
                          <time>
                            {formatDate(item.data.pubDate)}
                          </time>
                        </div>
                      </div>
                    </div>

                    <!-- Detalhes inline -->
                    {item.data.detail && (
                      <p class="text-gray-600 mb-3">{item.data.detail}</p>
                    )}

                    <!-- Informa√ß√µes da collection vinculada -->
                    {item.linkedContent && (
                      <div class="bg-white bg-opacity-50 rounded p-3 mb-3 text-sm">
                        {item.data.bookSlug && (
                          <div class="flex items-center gap-2">
                            <span class="text-gray-600">
                              por {item.linkedContent.data.author}
                            </span>
                            {item.linkedContent.data.rating && (
                              <>
                                <span class="text-gray-400">‚Ä¢</span>
                                <span class="text-yellow-600">
                                  {'‚≠ê'.repeat(item.linkedContent.data.rating)}
                                </span>
                              </>
                            )}
                          </div>
                        )}
                        {item.data.filmSlug && (
                          <div class="flex items-center gap-2">
                            <span class="text-gray-600">
                              dirigido por {item.linkedContent.data.director} ({item.linkedContent.data.year})
                            </span>
                            {item.linkedContent.data.rating && (
                              <>
                                <span class="text-gray-400">‚Ä¢</span>
                                <span class="text-yellow-600">
                                  {'‚≠ê'.repeat(item.linkedContent.data.rating)}
                                </span>
                              </>
                            )}
                          </div>
                        )}
                        {item.data.musicSlug && (
                          <div class="flex items-center gap-2">
                            <span class="text-gray-600">
                              {item.linkedContent.data.artist}
                              {item.linkedContent.data.album && ` - ${item.linkedContent.data.album}`}
                            </span>
                          </div>
                        )}
                      </div>
                    )}

                    <!-- Conte√∫do markdown -->
                    <div class="prose prose-sm max-w-none text-gray-700">
                      <Content />
                    </div>

                    <!-- Link externo se tiver -->
                    {item.data.url && (
                      <a 
                        href={item.data.url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-sm mt-3"
                      >
                        Acessar link externo ‚Üí
                      </a>
                    )}

                    <!-- Link para p√°gina detalhada -->
                    {item.linkedContent && (
                      <a 
                        href={`/${item.data.bookSlug ? 'livros' : item.data.filmSlug ? 'filmes' : 'musicas'}/${item.data.bookSlug || item.data.filmSlug || item.data.musicSlug}`}
                        class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700 text-sm mt-3"
                      >
                        Ver detalhes completos ‚Üí
                      </a>
                    )}

                    <!-- Tags -->
                    {item.data.tags && item.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-2 mt-4">
                        {item.data.tags.map(tag => (
                          <span class="text-xs px-2 py-1 bg-white bg-opacity-70 text-gray-600 rounded">
                            #{tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      </section>
    ))}

    <!-- Feed RSS -->
    <div class="mt-16 text-center">
      <a 
        href="/feed.xml" 
        class="inline-flex items-center gap-2 text-orange-600 hover:text-orange-700"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
        </svg>
        Assinar feed RSS
      </a>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-20">
    <div class="max-w-4xl mx-auto px-6 py-8">
      <div class="flex justify-between items-center text-sm text-gray-600">
        <p>¬© 2024 Bruno Pulis</p>
        <div class="flex gap-6">
          <a href="/feeds" class="hover:text-gray-900">RSS</a>
          <a href="/contato" class="hover:text-gray-900">Contato</a>
          <a href="https://twitter.com/brunopulis" class="hover:text-gray-900">Twitter</a>
          <a href="https://github.com/brunopulis" class="hover:text-gray-900">GitHub</a>
        </div>
      </div>
    </div>
  </footer>
</Layout>

<style>
  /* Estilos para o conte√∫do markdown */
  .prose p {
    margin-bottom: 0.75rem;
  }
  
  .prose a {
    color: #2563eb;
    text-decoration: none;
  }
  
  .prose a:hover {
    text-decoration: underline;
  }

  /* Sticky header suave */
  .sticky {
    backdrop-filter: blur(8px);
  }
</style>