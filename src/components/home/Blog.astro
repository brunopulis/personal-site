---
import { getCollection } from "astro:content";
import { ArrowRight } from "@lucide/astro";
import placeholderImg from "@/assets/images/site/placeholder.png";

const allPosts = await getCollection("blog");

// Ordenar por data mais recente
const sorted = allPosts.sort(
	(a, b) =>
		(b.data.publishDate?.getTime() ?? 0) - (a.data.publishDate?.getTime() ?? 0),
);

// featured: primeiro post, grid: pr√≥ximos 3, listPosts: os 3 mais recentes usados na lista abaixo
const featured = sorted[0];
const gridPosts = sorted.slice(1, 4);

// Helper para resolver a imagem (pode ser string ou ImageMetadata do bundler)
function getPostImage(post: any): string {
	const img =
		post?.data?.image ??
		post?.data?.coverImage ??
		post?.data?.seo?.image?.src ??
		placeholderImg;
	if (!img) return "";
	if (typeof img === "string") return img;
	// ImageMetadata shape: { src: string, ... }
	if (typeof img === "object" && "src" in img) return (img as any).src;
	return String(img);
}

function getPostImageAlt(post: any): string {
	return (
		post?.data?.imageAlt ??
		post?.data?.seo?.image?.alt ??
		post?.data?.title ??
		""
	);
}

function formatDate(date?: string | number | Date) {
	if (!date) return "";

	const formatter = new Intl.DateTimeFormat("pt-BR", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});

	return formatter.format(new Date(date));
}
---

<section id="blog" class="bg-gray-900 py-24 text-white">
  <div class="mx-auto max-w-6xl px-6">
    <div class="mb-16 text-center">
      <h2 class="mb-4 text-4xl font-bold">Coisas que tenho pensado</h2>
      <p class="text-xl font-light text-white">
        Escrevo sobre acessibilidade, tecnologia, teologia, produtividade e tudo que me faz refletir
      </p>
    </div>

    {
      featured && (
        <div class="mb-12 overflow-hidden rounded-2xl bg-gradient-to-br from-red-900 to-red-950 transition hover:scale-[1.02] hover:transform">
          <div class="grid gap-0 md:grid-cols-2">
            <div class="relative h-64 md:h-auto">
              <img
                src={getPostImage(featured)}
                alt={getPostImageAlt(featured)}
                class="h-full w-full object-cover"
                loading="lazy"
                width="552"
                height="260"
              />
            </div>
            <div class="flex flex-col justify-center p-8 md:p-12">
              <div class="mb-4 flex items-center gap-3">
                <span class="rounded-full bg-red-700 px-3 py-1 text-xs font-semibold text-red-100">
                  {' '}
                  {featured.data.category ?? 'Pessoal'}{' '}
                </span>
                <span class="text-sm text-white">{formatDate(featured.data.publishDate)}</span>
              </div>
              <h3 class="mb-4 text-3xl font-bold">{featured.data.title}</h3>
              <p class="mb-6 leading-relaxed text-white">{featured.data.excerpt}</p>
              <a
                href={'/blog/' + featured.id}
                class="inline-flex items-center gap-2 font-semibold text-white transition-all hover:gap-3"
              >
                Ler artigo completo
                <ArrowRight class="h-3 w-3" aria-hidden="true" />
              </a>
            </div>
          </div>
        </div>
      )
    }

    <div class="grid gap-6 md:grid-cols-3">
      {
        gridPosts.map((p) => (
          <div class="group overflow-hidden rounded-2xl bg-gray-800 transition hover:scale-105 hover:transform">
            <div class="relative h-48 overflow-hidden">
              <img
                src={getPostImage(p)}
                alt={getPostImageAlt(p)}
                loading="lazy"
                class="h-full w-full object-cover transition duration-300 group-hover:scale-110"
              />
            </div>
            <div class="p-6">
              <div class="mb-3 flex items-center gap-2">
                <span class="rounded-full bg-purple-600 px-3 py-1 text-xs font-semibold text-white">
                  {' '}
                  {p.data.category ?? 'Pessoal'}{' '}
                </span>
                <span class="text-xs text-gray-400">{formatDate(p.data.publishDate)}</span>
              </div>
              <h3 class="mb-2 text-xl font-bold transition group-hover:underline">{p.data.title}</h3>
              <p class="mb-4 text-sm text-white">{p.data.excerpt}</p>
              <a
                href={'/blog/' + p.id}
                class="flex items-center gap-2 text-sm font-semibold text-white transition-all group-hover:gap-3"
              >
                Ler artigo completo
                <ArrowRight class="h-3 w-3" aria-hidden="true" />
              </a>
            </div>
          </div>
        ))
      }
    </div>

    <div class="mt-12 text-center">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 rounded-lg bg-white px-8 py-4 font-semibold text-gray-900 transition hover:bg-gray-100"
      >
        Ver todos os artigos
        <ArrowRight class="h-4 w-4" />
      </a>
    </div>
  </div>
</section>
