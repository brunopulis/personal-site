---
import { Share2 } from '@lucide/astro';

interface Props {
  title: string;
  text: string;
  url: string;
  style?: 'simple | button | inline';
}

const { title, text, url, style = 'button' } = Astro.props;
---

{
  style === 'button' && (
    <div class="email-reply-button">
      <button class="reply-btn" data-title={title} data-text={text} data-url={url}>
        <Share2 class="h-5 w-5" aria-hidden="true" />
        <span class="hidden sm:inline">Compartilhar</span>
      </button>
    </div>
  )
}

<style>
  /* Estilo Simple - Inspirado no niqwithq */
  .email-reply-simple {
    margin: 2rem 0;
    border-left: 4px solid #0066cc;
    border-radius: 4px;
    background: #f8f9fa;
    padding: 1.5rem;
  }

  .email-reply-simple p {
    margin: 0;
    color: #333;
    font-size: 1rem;
  }

  .reply-link {
    transition: border-color 0.2s;
    border-bottom: 2px solid transparent;
    color: #0066cc;
    font-weight: 500;
    text-decoration: none;
  }

  .reply-link:hover {
    border-bottom-color: #0066cc;
  }

  /* Estilo Button - Inspirado no kevquirk */
  .email-reply-button {
    margin: 2rem 0;
    text-align: center;
  }

  .reply-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    border: 2px solid #0066cc;
    border-radius: 6px;
    background: #0066cc;
    padding: 0.75rem 1.5rem;
    color: white;
    font-weight: 500;
    font-size: 1rem;
    text-decoration: none;
  }

  .reply-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
    border-color: #0052a3;
    background: #0052a3;
  }

  .reply-btn svg {
    flex-shrink: 0;
  }

  /* Estilo Inline - Mais discreto */
  .email-reply-inline {
    margin: 2rem 0;
    border-top: 1px solid #e0e0e0;
    border-bottom: 1px solid #e0e0e0;
    padding: 1rem 0;
  }

  .email-reply-inline p {
    margin: 0;
    color: #666;
    font-size: 0.95rem;
    text-align: center;
  }

  .reply-link-inline {
    color: #0066cc;
    font-weight: 500;
    text-decoration: underline;
  }

  .reply-link-inline:hover {
    color: #0052a3;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .email-reply-simple {
      border-left-color: #4d94ff;
      background: #1a1a1a;
    }

    .email-reply-simple p {
      color: #e0e0e0;
    }

    .reply-link {
      color: #4d94ff;
    }

    .reply-link:hover {
      border-bottom-color: #4d94ff;
    }

    .reply-btn {
      border-color: #4d94ff;
      background: #4d94ff;
    }

    .reply-btn:hover {
      box-shadow: 0 4px 8px rgba(77, 148, 255, 0.3);
      border-color: #3d7dd6;
      background: #3d7dd6;
    }

    .email-reply-inline {
      border-color: #333;
    }

    .email-reply-inline p {
      color: #b0b0b0;
    }

    .reply-link-inline {
      color: #4d94ff;
    }

    .reply-link-inline:hover {
      color: #3d7dd6;
    }
  }
</style>

<script>
  function initShareButtons() {
    const shareButtons = document.querySelectorAll('.share-button');

    shareButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const title = button.getAttribute('data-title') || '';
        const text = button.getAttribute('data-text') || '';
        const url = button.getAttribute('data-url') || '';

        // Formatar o texto para compartilhar no Fediverso
        const shareText = `${text}\n\n${url}`;

        // Verificar se o navegador suporta Web Share API
        if (navigator.share) {
          try {
            await navigator.share({
              title: title,
              text: shareText,
            });
            console.log('Compartilhado com sucesso!');
          } catch (err) {
            // Usuário cancelou ou erro ocorreu
            if (err instanceof Error && err.name !== 'AbortError') {
              console.error('Erro ao compartilhar:', err);
              fallbackShare(shareText);
            }
          }
        } else {
          // Fallback para navegadores que não suportam Web Share API
          fallbackShare(shareText);
        }
      });
    });
  }

  function fallbackShare(text: string) {
    if (navigator.clipboard) {
      navigator.clipboard
        .writeText(text)
        .then(() => {
          showNotification(
            'Texto copiado para a área de transferência! Cole no seu app do Fediverso.'
          );
        })
        .catch((err) => {
          console.error('Erro ao copiar:', err);
          showNotification('Erro ao copiar texto', true);
        });
    } else {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showNotification('Texto copiado para a área de transferência!');
      } catch (err) {
        console.error('Erro ao copiar:', err);
        showNotification('Erro ao copiar texto', true);
      }
      document.body.removeChild(textArea);
    }
  }

  function showNotification(message: string, isError = false) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transition-opacity duration-300 ${
      isError ? 'bg-red-600' : 'bg-green-600'
    }`;
    toast.textContent = message;
    toast.style.opacity = '0';

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '1';
    }, 10);

    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  document.addEventListener('DOMContentLoaded', initShareButtons);
  document.addEventListener('astro:page-load', initShareButtons);
</script>
