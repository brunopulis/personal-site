---
import type { Language, TranslationKey } from '@i18n/index';
import type { CollectionEntry } from 'astro:content';

import { getLocalizedPath } from '@/i18n/utils';

interface Props {
  streams: CollectionEntry<'stream'>[];
  t: (key: TranslationKey) => string;
  locale?: Language;
}

const { streams, t, locale = 'pt-br' } = Astro.props;

const iconMap: Record<string, string> = {
  book: 'ğŸ“š',
  music: 'ğŸµ',
  film: 'ğŸ¬',
  podcast: 'ğŸ§',
  concert: 'ğŸ¤',
  link: 'ğŸ”—',
  note: 'ğŸ’­',
  post: 'âœï¸',
};

function formatRelativeDate(date: Date): string {
  if (!(date instanceof Date) || isNaN(date.getTime())) {
    return t('home.stream.invalid_date');
  }

  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (days === 0) return t('home.stream.today');
  if (days === 1) return t('home.stream.yesterday');
  if (days < 7) return `${days} ${t('home.stream.days_ago')}`;
  if (days < 30) return `${Math.floor(days / 7)} ${t('home.stream.weeks_ago')}`;
  return date.toLocaleDateString(locale);
}
---

<div class="grid" data-layout="stream">
  {
    streams.map((item) => (
      <article class="card | stream__item">
        <div class="flow">
          <span class="stream__item-icon" aria-hidden="true">
            {iconMap[item.data.type] || 'ğŸ“'}
          </span>
          <div class="stream__item-content">
            <h3 class="stream__item-title">{item.data.title}</h3>
            <p>{item.data.detail}</p>
            <time class="dt-published stream__item-date" datetime={item.data.pubDate.toISOString()}>
              {formatRelativeDate(item.data.pubDate)}
            </time>
          </div>
        </div>
      </article>
    ))
  }
</div>

<p class="" style="margin-top: 20px;">
  <a href={getLocalizedPath('stream', locale)}>{t('home.stream.view_all')}</a>
</p>

<style>
  .stream__item {
    border-radius: 8px;
    background: var(--card-background);
    padding: 20px;
  }

  .stream__item-icon {
    color: var(--color-border);
    font-size: 1.5rem;
  }

  .stream__item-date {
    margin-top: 0.5rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }
</style>
